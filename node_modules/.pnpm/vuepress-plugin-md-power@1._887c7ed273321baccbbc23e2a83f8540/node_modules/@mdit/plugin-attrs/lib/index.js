import{isSpace as A}from"markdown-it/lib/common/utils.mjs";const w=46,x=35,O=32,I=61,E=34,T=n=>!(n===9||n===10||n===12||n===32||n===47||n===62||n===34||n===39||n===61),K=(n,t,e)=>{let l="",i="",s=!0,o=!1;const r=[];for(let c=t[0];c<t[1];c++){const a=n.charCodeAt(c);if(a===I&&s){s=!1;continue}if(a===w&&l===""){n.charCodeAt(c+1)===w?(l="css-module",c++):l="class",s=!1;continue}if(a===x&&l===""){l="id",s=!1;continue}if(a===E&&i===""&&!o){o=!0;continue}if(a===E&&o){o=!1;continue}if(a===O&&!o){if(l==="")continue;r.push([l,i]),l="",i="",s=!0;continue}if(!(s&&!T(a))){if(s){l+=String.fromCharCode(a);continue}i+=String.fromCharCode(a)}}return l!==""&&r.push([l,i]),e.length?r.filter(([c])=>e.some(a=>a instanceof RegExp?a.test(c):a===c)):r},y=(n,t,e,l)=>{n&&K(t,e,l).forEach(([i,s])=>{switch(i){case"class":n.attrJoin("class",s);break;case"css-module":n.attrJoin("css-module",s);break;default:n.attrPush([i,s])}})},m=({left:n,right:t},e)=>{if(!["start","end","only"].includes(e))throw new Error(`Invalid 'where' parameter: ${e}. Expected 'start', 'end', or 'only'.`);const l=n.length,i=t.length,s=l+1+i;return o=>{if(typeof o!="string"||o.length<s)return!1;let r,c;if(e==="start"){if(!o.startsWith(n)||(r=l,c=o.indexOf(t,l+1),c===-1))return!1;const u=c+i;if(u<o.length&&t.includes(o.charAt(u)))return!1}else if(e==="end"){if(r=o.lastIndexOf(n),r===-1||(c=o.indexOf(t,r+l+1),r+=l,c===-1||c+i!==o.length))return!1}else{if(!o.startsWith(n)||!o.endsWith(t))return!1;r=l,c=o.length-i}const a=o.charCodeAt(r),p=c-r;return(a===w||a===x?p>=2:p>=1)?[r,c]:!1}},_=(n,t)=>{const e=n[t];if(e.type==="softbreak")return null;if(e.nesting===0)return e;const l=e.level,i=e.type.replace("_close","_open");for(;t>=0;){const s=n[t];if(s.type===i&&s.level===l)return s;t--}/* istanbul ignore next -- @preserve */return null},M=(n,t)=>t>=0?n[t]:n[n.length+t],R=(n,t,e)=>{const l={match:!1,position:null,range:null},i=e.shift!==void 0,s=i?t+e.shift:e.position;if(i&&s<0)return l;const o=M(n,s);if(!o)return l;for(const r of Object.keys(e)){if(r==="shift"||r==="position")continue;if(o[r]==null)return l;if(r==="children"&&Array.isArray(e.children)){if(!o.children?.length)return l;const a=e.children,p=o.children;let u,d=null;if(a.every(f=>f.position!=null)){if(u=a.every(f=>{const h=R(p,f.position,f);return h.match?(h.range&&(d=h.range),!0):!1}),u){const{position:f}=a[a.length-1];l.position=f>=0?f:p.length+f,l.range=d}}else for(let f=0;f<p.length;f++)if(u=a.every(h=>{const b=R(p,f,h);return b.match?(b.range&&(d=b.range),!0):!1}),u){l.position=f,d&&(l.range=d);break}if(u===!1)return l;continue}const c=e[r];switch(typeof c){case"boolean":case"number":case"string":{if(o[r]!==c)return l;break}case"function":{const a=c(o[r]);if(!a)return l;Array.isArray(a)&&(l.range=a);break}default:throw new Error(`Unknown type of pattern test (key: ${r}). Test should be of type boolean, number, string or function.`)}}return l.match=!0,l},P=n=>({name:"end of block",tests:[{shift:0,type:"inline",children:[{position:-1,content:m(n,"end"),type:t=>t!=="code_inline"&&t!=="math_inline"}]}],transform:(t,e,l,i)=>{const s=i[0]-n.left.length,o=t[e].children[l],{content:r}=o,c=A(r.charCodeAt(s-1));let a=e+1;for(;t[a+1]?.nesting===-1;)a++;const p=_(t,a);y(p,r,i,n.allowed),o.content=r.slice(0,c?s-1:s)}}),W=n=>({name:"code-block",tests:[{shift:0,block:!0,info:m(n,"end")}],transform:(t,e,l,i)=>{const s=i[0]-n.left.length,o=t[e],{info:r}=o,c=A(r.charCodeAt(s-1));y(o,r,i,n.allowed),o.info=r.slice(0,c?s-1:s)}}),B=n=>({name:"end of block",tests:[{shift:-1,type:"heading_open"},{shift:0,type:"inline",children:[{position:-1,content:m(n,"end"),type:t=>t!=="code_inline"&&t!=="math_inline"}]}],transform:(t,e,l,i)=>{const s=i[0]-n.left.length,o=t[e].children[l],{content:r}=o,c=A(r.charCodeAt(s-1)),a=_(t,e+1);y(a,r,i,n.allowed),o.content=r.slice(0,c?s-1:s)}}),D=n=>[{name:"inline nesting self-close",tests:[{shift:0,type:"inline",children:[{shift:-1,type:t=>t==="image"||t==="code_inline"},{shift:0,type:"text",content:m(n,"start")}]}],transform:(t,e,l,i)=>{const s=t[e].children,o=s[l],r=s[l-1],c=n.right.length+i[1];y(r,o.content,i,n.allowed),o.content.length===c?s.splice(l,1):o.content=o.content.slice(c)}},{name:"inline attributes",tests:[{shift:0,type:"inline",children:[{shift:-1,nesting:-1},{shift:0,type:"text",content:m(n,"start")}]}],transform:(t,e,l,i)=>{const s=t[e].children,o=s[l],{content:r}=o,c=n.right.length+i[1],a=_(s,l-1);y(a,r,i,n.allowed),o.content=r.slice(c)}}],G=n=>[{name:"list softbreak",tests:[{shift:-2,type:"list_item_open"},{shift:0,type:"inline",children:[{position:-2,type:"softbreak"},{position:-1,type:"text",content:m(n,"only")}]}],transform:(t,e,l,i)=>{const s=t[e].children,o=s[l];let r=e-2;for(;t[r-1]?.type!=="ordered_list_open"&&t[r-1].type!=="bullet_list_open";)r--;y(t[r-1],o.content,i,n.allowed),t[e].children=s.slice(0,-2)}},{name:"list double softbreak",tests:[{shift:0,type:t=>t==="bullet_list_close"||t==="ordered_list_close"},{shift:1,type:"paragraph_open"},{shift:2,type:"inline",content:m(n,"only"),children:t=>t.length===1},{shift:3,type:"paragraph_close"}],transform:(t,e,l,i)=>{const s=t[e+2],o=_(t,e);y(o,s.content,i,n.allowed),t.splice(e+1,3)}},{name:"list item end",tests:[{shift:-2,type:"list_item_open"},{shift:0,type:"inline",children:[{position:-1,type:"text",content:m(n,"end")}]}],transform:(t,e,l,i)=>{const s=t[e].children[l],{content:o}=s,r=i[0]-n.left.length,c=A(o.charCodeAt(r-1));y(t[e-2],o,i,n.allowed),s.content=o.slice(0,c?r-1:r)}}],H=n=>({name:`
{.a} softbreak then curly in start`,tests:[{shift:0,type:"inline",children:[{position:-2,type:"softbreak"},{position:-1,type:"text",content:m(n,"only")}]}],transform:(t,e,l,i)=>{const s=t[e].children,o=s[l];let r=e+1;for(;t[r+1]?.nesting===-1;)r++;y(_(t,r),o.content,i,n.allowed),t[e].children=s.slice(0,-2)}}),J=n=>({name:"horizontal rule",tests:[{shift:0,type:"paragraph_open"},{shift:1,type:"inline",children:t=>t.length===1,content:t=>{let e=0,l;const i=t.charCodeAt(e++);if(i!==45&&i!==42&&i!==95)return!1;let s=1;for(;e<t.length&&(l=t.charCodeAt(e++),l===i);)s++;return s<3?!1:(A(t.charCodeAt(e-1))||e--,m(n,"end")(t))}},{shift:2,type:"paragraph_close"}],transform:(t,e,l,i)=>{const s=t[e],o=t[e+1],{content:r}=o;s.type="hr",s.tag="hr",s.nesting=0,y(s,r,i,n.allowed),s.markup=r,t.splice(e+1,2)}}),L=n=>[{name:"table",tests:[{shift:0,type:"table_close"},{shift:1,type:"paragraph_open"},{shift:2,type:"inline",content:m(n,"only")}],transform:(t,e,l,i)=>{const s=t[e+2],o=_(t,e);y(o,s.content,i,n.allowed),t.splice(e+1,3)}},{name:"table cell attributes",tests:[{shift:-1,type:t=>t==="td_open"||t==="th_open"},{shift:0,type:"inline",children:[{shift:0,type:"text",content:m(n,"end")}]}],transform:(t,e,l,i)=>{const s=i[0]-n.left.length,o=t[e].children[l],r=t[e-1],{content:c}=o,a=A(c.charCodeAt(s-1));y(r,c,i,n.allowed),o.content=c.slice(0,a?s-1:s)}},{name:"table thead metadata",tests:[{shift:0,type:"tr_close"},{shift:1,type:"thead_close"},{shift:2,type:"tbody_open"}],transform:(t,e)=>{const l=_(t,e),i=t[e-1];let s=0,o=e-1;for(;o>0;){const c=t[o];if(c===l){const a=t[o-1];a.meta={...a.meta,columnCount:s};break}c.level===i.level&&c.type===i.type&&s++,o--}const r=t[e+2];r.meta={...r.meta,columnCount:s}}},{name:"table tbody calculate",tests:[{shift:0,type:"tbody_close",hidden:!1}],transform:(t,e)=>{let l=e-2;for(;l>=0&&t[l].type!=="tbody_open";)l--;const i=t[l].meta?.columnCount??0;if(i<2)return;const s=Array.from({length:i}).fill(0),o=[];let r=l+1;for(;r<e;){const c=r;let a=c+1;for(;a<e&&t[a].type!=="tr_close";)a++;const p=[];let u=c+1;for(;u<a;){let h=u+1;for(;h<a&&t[h].type!=="td_close"&&t[h].type!=="th_close";)h++;p.push([u,h]),u=h+1}let d=0,f=0;for(;f<i;){if(s[f]>0){s[f]--,o.push(p[d]),d++,f++;continue}const h=t[p[d][0]],b=Number(h.attrGet("colspan"))||1,S=Number(h.attrGet("rowspan"))||1;d++;let k=0;for(let g=0;g<b;g++)if(f+g<i)if(s[f+g]===0)k++;else break;b>1&&k<b&&h.attrSet("colspan",String(k));for(let g=0;g<k;g++)f+g<i&&(s[f+g]=S-1);const C=k-1;if(C>0)for(let g=0;g<C;g++)o.push(p[d]),d++;f+=k}r=a+1}o.sort((c,a)=>a[0]-c[0]);for(const[c,a]of o)t.splice(c,a-c+1)}}],v=["fence","inline","table","list","heading","hr","softbreak","block"],N=n=>{const t=n.rule===!1?[]:Array.isArray(n.rule)?n.rule.filter(l=>v.includes(l)):v,e=[];return t.includes("fence")&&e.push(W(n)),t.includes("inline")&&e.push(...D(n)),t.includes("table")&&e.push(...L(n)),t.includes("list")&&e.push(...G(n)),t.includes("softbreak")&&e.push(H(n)),t.includes("hr")&&e.push(J(n)),t.includes("block")?e.push(P(n)):t.includes("heading")&&e.push(B(n)),e},U=(n,{left:t="{",right:e="}",allowed:l=[],rule:i="all"}={})=>{const s=N({left:t,right:e,allowed:l,rule:i}),o=({tokens:r})=>{for(let c=0;c<r.length;c++)for(let a=0;a<s.length;a++){const p=s[a];let u=null,d=null;p.tests.every(f=>{const h=R(r,c,f);return h.position!==null&&({position:u}=h),h.range&&(d=h.range),h.match})&&(p.transform(r,c,u,d),(p.name==="inline attributes"||p.name==="inline nesting self-close")&&a--)}};n.core.ruler.before("linkify","attrs",o)};export{U as attrs};
//# sourceMappingURL=index.js.map
